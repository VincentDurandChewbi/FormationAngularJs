<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.0/angular.min.js"></script>
    <title>Donjon et dragon</title>
</head>

<body>
    <div ng-app="app" ng-controller="myCtrl">

        <p ng-if="classes">
        <ul>
            <li ng-repeat="class in classes.results" ng-click="afficheClasse(class.index)">{{class.name}}</li>
        </ul>
        </p>

        <div ng-if="detail">
            <p>
                Hit Die : {{detail.hit_die}}

            </p>

            <p>
                Compétences :
            <ul>
                <li ng-repeat="comp in detail.proficiencies">
                    {{comp.name}}
                </li>
            </ul>
            </p>


            <p>
                Compétences au choix : {{detail.proficiency_choices[0].choose}}
            <ul>
                <li ng-repeat="pro in detail.proficiency_choices[0].from" ng-click=getComp(pro.url)>
                    {{pro.name}}
                    <pre ng-if="compDetail && pro.index == compDetail.index">{{compDetail | json}}</pre>
                </li>
            </ul>
            </p>

            <!-- <pre>{{detail | json}}</pre> -->

        </div>

        <div ng-if="monsters">
            <ul>
                <!-- le limitTo permet la pagination limitTo:20:50 signifie affiche 20 résultats offset 50 (à partir du 50ème) -->
                <li ng-repeat="monster in monsters.results | limitTo:20:pageOffset">
                    {{monster.name}}
                </li>
            </ul>
            <button ng-if="pageOffset > 0" ng-click="previous()">Previous</button>
            <button ng-click="next()">Next</button>
        </div>

    </div>

    <script>
        let app = angular.module('app', []);
        app.controller('myCtrl', function ($scope, $http) {
            $scope.classes = false;
            $scope.detail = false;
            $scope.compDetail = false;
            $scope.monsters = false;
            $scope.pageOffset = 0;
            $scope.pageLimit = 0;
            $scope.next = function() {
                if ($scope.pageOffset + 20 <=  $scope.pageLimit){
                    $scope.pageOffset += 20
                }
            }

            $scope.previous = function() {
                if ($scope.pageOffset - 20 >= 0){
                    $scope.pageOffset -= 20
                }
            }



            $scope.getClasses = function () {

                $http({
                    method: "GET",
                    url: "https://www.dnd5eapi.co/api/classes",
                    params: {}
                })

                    // $http.get("http://api.frankfurter.app/latest?from=EUR&to=USD")
                    .then(function (response) {
                        console.log(response);
                        $scope.classes = response.data;
                    })
                    .catch(function (error) {
                        console.log(error);
                    })
            };

            $scope.afficheClasse = function (id) {
                // $http({
                //     method: "GET",
                //     url: "https://www.dnd5eapi.co/api/classes/",
                //     params: {index: id}
                // })

                $http.get("https://www.dnd5eapi.co/api/classes/" + id)
                    .then(function (response) {
                        console.log(response);
                        $scope.detail = response.data;
                    })
                    .catch(function (error) {
                        console.log(error);
                    })
            }

            $scope.getComp = function (url) {
                $http.get("https://www.dnd5eapi.co" + url)
                    .then(function (response) {
                        console.log(response);
                        $scope.compDetail = response.data;
                    })
                    .catch(function (error) {
                        console.log(error);
                    })
            }

            $scope.getMonsters = function () {


                $http({
                    method: "GET",
                    url: "https://www.dnd5eapi.co/api/monsters",
                    params: {}
                })

                    // $http.get("http://api.frankfurter.app/latest?from=EUR&to=USD")
                    .then(function (response) {
                        console.log(response);
                        $scope.monsters = response.data;
                        $scope.pageLimit = response.data.count;
                    })
                    .catch(function (error) {
                        console.log(error);
                    })
            };

            $scope.getClasses()
            $scope.getMonsters();

        });
    </script>

</body>

</html>